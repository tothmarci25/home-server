- name: Create Argo CD namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ argocd_namespace }}"

- name: Install Argo CD
  kubernetes.core.k8s:
    state: present
    src: "{{ argocd_install_url }}"
    namespace: "{{ argocd_namespace }}"

- name: Wait for Argo CD pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ argocd_namespace }}"
  register: argocd_pods
  until: >
    argocd_pods.resources | length > 0 and
      (
        argocd_pods.resources
        | selectattr('status', 'defined')
        | selectattr('status.containerStatuses', 'defined')
        | map(attribute='status.containerStatuses')
        | flatten
        | map(attribute='ready')
        | default([false])
        | min
      )
  retries: 30
  delay: 10

- name: Get Argo CD admin password
  command: >
    kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret
    -o jsonpath="{.data.password}"
  register: argocd_admin_password
  changed_when: false

- name: Show Argo CD admin password
  debug:
    msg: "Argo CD admin password: {{ argocd_admin_password.stdout | b64decode }}"

- name: Copy GitOps root app manifest to server
  copy:
    src: "{{ playbook_dir }}/../../k8s-manifests/bootstrap/root-app.yaml"
    dest: /tmp/root-app.yaml
    mode: '0644'

- name: Bootstrap GitOps (root App)
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../../k8s-manifests/bootstrap/root-app.yaml"

- name: Remove temporary manifest
  file:
    path: /tmp/root-app.yaml
    state: absent
