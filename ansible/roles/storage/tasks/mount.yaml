- name: Check disks
  stat:
    path: "/dev/disk/by-uuid/{{ item.uuid }}"
  register: disk_checks
  loop: "{{ usb_disks }}"

- name: Ensure mount dirs exist
  file:
    path: "/mnt/{{ item.name }}"
    state: directory
  loop: "{{ usb_disks }}"

- name: Mount disks
  mount:
    path: "/mnt/{{ item.name }}"
    src: "UUID={{ item.uuid }}"
    fstype: "{{ item.fstype | default('ext4') }}"
    state: mounted
  when: 
    - disk_checks.results[disk_idx].stat.exists
    - >
      ansible_mounts
      | selectattr('uuid', 'equalto', item.uuid)
      | selectattr('mount', 'equalto', '/mnt/' ~ item.name)
      | list
      | length == 0
  loop: "{{ usb_disks }}"
  loop_control:
    index_var: disk_idx

- name: Label node (disk present)
  command: >
    kubectl label node {{ k8s_node_name }}
    usb.{{ item.name }}=true --overwrite
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: disk_checks.results[disk_idx].stat.exists
  loop: "{{ usb_disks }}"
  loop_control:
    index_var: disk_idx

- name: Label node (disk missing)
  command: >
    kubectl label node {{ k8s_node_name }}
    usb.{{ item.name }}=false --overwrite
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: not disk_checks.results[disk_idx].stat.exists
  loop: "{{ usb_disks }}"
  loop_control:
    index_var: disk_idx
